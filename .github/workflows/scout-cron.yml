name: Scout — Hourly Codebase Analysis

on:
  schedule:
    - cron: '0 * * * *'  # Every hour on the hour
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Specific project ID (leave empty for all scheduled projects)'
        required: false

jobs:
  scout:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Trigger scout jobs
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -euo pipefail

          CURRENT_HOUR=$(date -u +%-H)
          CURRENT_DOW=$(date -u +%u)  # 1=Monday ... 7=Sunday

          # Fetch active projects that have a scout_schedule and are not paused
          PROJECTS=$(curl -sf \
            -H "apikey: $SUPABASE_KEY" \
            -H "Authorization: Bearer $SUPABASE_KEY" \
            -H "Accept-Profile: minions" \
            "$SUPABASE_URL/rest/v1/projects?select=id,scout_schedule&github_repo=not.is.null&scout_schedule=not.is.null&paused=not.is.true")

          echo "Found projects: $(echo "$PROJECTS" | jq -r 'length')"

          for ROW in $(echo "$PROJECTS" | jq -c '.[]'); do
            PROJECT_ID=$(echo "$ROW" | jq -r '.id')
            SCHEDULE=$(echo "$ROW" | jq -r '.scout_schedule')

            # Skip if a specific project was requested and this isn't it
            if [ -n "${{ github.event.inputs.project_id }}" ] && [ "$PROJECT_ID" != "${{ github.event.inputs.project_id }}" ]; then
              continue
            fi

            # Simple cron matching: parse minute hour dow from scout_schedule
            # Format: "min hour * * dow" — we check hour and day-of-week
            CRON_HOUR=$(echo "$SCHEDULE" | awk '{print $2}')
            CRON_DOW=$(echo "$SCHEDULE" | awk '{print $5}')

            # Check hour match (supports * or specific number)
            if [ "$CRON_HOUR" != "*" ] && [ "$CRON_HOUR" != "$CURRENT_HOUR" ]; then
              echo "Skipping project $PROJECT_ID — hour mismatch (schedule=$CRON_HOUR, now=$CURRENT_HOUR)"
              continue
            fi

            # Check day-of-week match (supports * or specific number, cron 0/7=Sun,1=Mon...6=Sat)
            if [ "$CRON_DOW" != "*" ]; then
              # Convert cron dow (0-6, Sun=0) to date dow (1-7, Mon=1)
              # cron: 0=Sun,1=Mon,...,6=Sat  →  date -u +%u: 1=Mon,...,7=Sun
              if [ "$CRON_DOW" = "0" ] || [ "$CRON_DOW" = "7" ]; then
                CRON_DOW_CONVERTED=7
              else
                CRON_DOW_CONVERTED=$CRON_DOW
              fi
              if [ "$CRON_DOW_CONVERTED" != "$CURRENT_DOW" ]; then
                echo "Skipping project $PROJECT_ID — dow mismatch (schedule=$CRON_DOW, now=$CURRENT_DOW)"
                continue
              fi
            fi

            # Dedup check: skip if a scout job is already pending or processing for this project
            EXISTING=$(curl -sf \
              -H "apikey: $SUPABASE_KEY" \
              -H "Authorization: Bearer $SUPABASE_KEY" \
              -H "Accept-Profile: minions" \
              "$SUPABASE_URL/rest/v1/job_queue?select=id&project_id=eq.$PROJECT_ID&job_type=eq.scout&status=in.(pending,processing)&limit=1")

            if [ "$(echo "$EXISTING" | jq 'length')" -gt 0 ]; then
              echo "Skipping project $PROJECT_ID — scout job already pending/processing"
              continue
            fi

            # Queue a scout job
            RESULT=$(curl -sf -X POST \
              -H "apikey: $SUPABASE_KEY" \
              -H "Authorization: Bearer $SUPABASE_KEY" \
              -H "Content-Profile: minions" \
              -H "Content-Type: application/json" \
              -H "Prefer: return=representation" \
              "$SUPABASE_URL/rest/v1/job_queue" \
              -d "{\"project_id\": \"$PROJECT_ID\", \"job_type\": \"scout\", \"github_issue_number\": 0, \"issue_title\": \"Scheduled scout\", \"issue_body\": \"{}\"}" \
              || echo "FAILED")

            if [ "$RESULT" = "FAILED" ]; then
              echo "::warning::Failed to queue scout for project $PROJECT_ID"
            else
              echo "Queued scout for project $PROJECT_ID"
            fi
          done
